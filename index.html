<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agar.io - Buyable Skin Bundles (USD)</title>
    <style>
        :root {
            --background-color: #f0f2f5;
            --card-background: #ffffff;
            --text-primary: #1c1e21;
            --text-secondary: #606770;
            --text-tertiary: #8a8d91;
            --price-color: #38a169;
            --accent-color: #4A90E2;
            --border-color: #dddfe2;
            --shadow-light: rgba(0, 0, 0, 0.06);
            --shadow-medium: rgba(0, 0, 0, 0.1);
            --danger-color: #e74c3c;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            margin: 0;
            overflow-x: hidden;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
        }
        header {
            text-align: center;
            margin-bottom: 20px;
            position: relative;
        }
        h1 { font-size: 2.25rem; color: var(--text-primary); font-weight: 700; margin: 0; }
        
        #creator-credit {
            position: absolute;
            top: 0;
            right: 0;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-tertiary);
        }

        #debug-container {
            margin-top: 12px;
            font-size: 12px;
            color: var(--text-secondary);
            background-color: #e9ecef;
            padding: 6px 12px;
            border-radius: 6px;
            display: inline-block;
            border: 1px solid var(--border-color);
        }
        #debug-log {
            font-family: monospace;
            font-weight: bold;
            color: #000;
        }

        #controls-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-bottom: 32px;
        }
        #search-box {
            width: 100%; max-width: 500px; padding: 12px 16px; font-size: 16px;
            border: 1px solid var(--border-color); border-radius: 24px;
            box-shadow: 0 1px 3px var(--shadow-light); transition: all 0.2s; box-sizing: border-box;
        }
        #search-box:focus {
            outline: none; border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
        }

        /* --- Filter Styles --- */
        #filter-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 15px;
            width: 100%;
            max-width: 1000px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 12px;
        }
        .filter-group { display: flex; align-items: center; gap: 8px; }
        .filter-group label { font-weight: 600; font-size: 14px; color: var(--text-secondary); }
        .filter-group select, .filter-btn, .reset-btn {
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: white;
            cursor: pointer;
        }
        .filter-btn { transition: background-color 0.2s, color 0.2s; }
        .filter-btn.active {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        .reset-btn { background-color: var(--danger-color); color: white; border-color: var(--danger-color); font-weight: 600; }

        #skin-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 24px; }
        .section-header {
            grid-column: 1 / -1; font-size: 1.5rem; font-weight: 600; color: var(--text-secondary);
            margin: 20px 0 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; text-align: left;
        }
        .skin-card {
            background-color: var(--card-background); border-radius: 12px;
            box-shadow: 0 2px 8px var(--shadow-light); text-align: center;
            padding: 16px; display: flex; flex-direction: column; transition: all 0.2s;
        }
        .skin-card:hover { transform: translateY(-5px); box-shadow: 0 6px 16px var(--shadow-medium); }
        .skin-card .image-container { display: flex; justify-content: center; align-items: center; gap: 10px; min-height: 110px; margin-bottom: 12px; flex-wrap: wrap; }
        .skin-card .image-container img { width: 90px; height: 90px; object-fit: contain; }
        .skin-card .details-container { display: flex; flex-direction: column; flex-grow: 1; }
        .skin-card .item-list { list-style: none; padding: 0; margin: 8px 0; flex-grow: 1; }
        .skin-card .item-list li { font-size: 14px; font-weight: 500; color: var(--text-secondary); }
        .skin-card .price { font-size: 20px; font-weight: bold; color: var(--price-color); margin-top: 12px; }
        .add-to-cart-btn {
            background-color: var(--accent-color); color: white; border: none;
            padding: 10px 16px; margin-top: 16px; font-size: 14px; font-weight: 600;
            border-radius: 8px; cursor: pointer; transition: background-color 0.2s;
        }
        .add-to-cart-btn.in-cart { background-color: var(--price-color); cursor: not-allowed; }
        #loading-message, #no-results-message { grid-column: 1 / -1; text-align: center; font-size: 18px; color: var(--text-secondary); margin-top: 50px; }
        .hidden { display: none !important; }

        /* --- Cart System --- */
        #cart-button {
            position: fixed; bottom: 30px; right: 30px;
            width: 60px; height: 60px; background-color: var(--accent-color);
            border-radius: 50%; border: none; cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: flex; justify-content: center; align-items: center;
            transition: transform 0.2s; z-index: 1001;
        }
        #cart-button:hover { transform: scale(1.1); }
        #cart-count {
            position: absolute; top: -5px; right: -5px;
            background-color: var(--danger-color); color: white;
            border-radius: 50%; width: 24px; height: 24px;
            font-size: 14px; font-weight: bold; line-height: 24px; text-align: center;
            transform: scale(0); transition: transform 0.2s;
        }
        #cart-count.visible { transform: scale(1); }
        #cart-sidebar {
            position: fixed; top: 0; right: -400px;
            width: 100%; max-width: 400px; height: 100%;
            background-color: var(--card-background);
            box-shadow: -4px 0 20px rgba(0,0,0,0.15);
            transition: right 0.3s ease-in-out;
            display: flex; flex-direction: column; z-index: 1000;
        }
        #cart-sidebar.open { right: 0; }
        #cart-header { padding: 20px; border-bottom: 1px solid var(--border-color); }
        #cart-header h2 { margin: 0; font-size: 1.5rem; }
        #cart-items { flex-grow: 1; overflow-y: auto; padding: 10px 20px; }
        .cart-item { display: flex; align-items: center; padding: 15px 0; border-bottom: 1px solid #eee; }
        .cart-item-details { flex-grow: 1; }
        .cart-item-details .name { font-weight: 600; margin: 0 0 5px; font-size: 14px; word-break: break-all; }
        .cart-item-details .price { color: var(--text-secondary); margin: 0; }
        .remove-item-btn { background: none; border: none; cursor: pointer; font-size: 20px; color: var(--text-tertiary); }
        #cart-footer { padding: 20px; border-top: 1px solid var(--border-color); background-color: #f9fafb; }
        #cart-total { display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; }
        #checkout-btn, #clear-cart-btn { width: 100%; padding: 12px; border-radius: 8px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; }
        #checkout-btn { background-color: var(--price-color); color: white; }
        #clear-cart-btn { background-color: var(--danger-color); color: white; margin-top: 10px; }

        /* --- Shared Modal Styles --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 2000; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; transform: scale(0.9); transition: transform 0.3s; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-content h2 { margin-top: 0; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .modal-btn { flex-grow: 1; padding: 10px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; }
        #copy-btn { background-color: var(--accent-color); color: white; }
        #close-modal-btn, #close-owner-modal-btn { background-color: var(--border-color); }
        textarea { width: 100%; min-height: 120px; margin: 15px 0 0; font-family: monospace; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; resize: vertical; box-sizing: border-box; }

        /* --- Owner's Menu Specific Styles --- */
        #decrypted-order-results { margin-top: 20px; max-height: 40vh; overflow-y: auto; }
        .decrypted-item { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .decrypted-item .name { font-weight: bold; font-size: 1.1em; }
        .decrypted-item .price { color: var(--price-color); }
        .decrypted-item-images { display: flex; gap: 10px; margin-top: 10px; }
        .decrypted-item-images img { width: 60px; height: 60px; object-fit: contain; border-radius: 5px; background: #f9f9f9; }
        .decrypted-summary { font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Agar.io Buyable Bundles</h1>
            <div id="creator-credit">Created by vo3pal</div>
            <div id="debug-container">Live Game ID: <span id="debug-log">Fetching...</span></div>
        </header>

        <div id="controls-container">
            <input type="text" id="search-box" placeholder="Search for skins or bundles..." />
            <div id="filter-container">
                <div class="filter-group">
                    <label for="min-price">Min Price:</label>
                    <select id="min-price"><option value="0">Any</option></select>
                </div>
                <div class="filter-group">
                    <label for="max-price">Max Price:</label>
                    <select id="max-price"><option value="Infinity">Any</option></select>
                </div>
                <div class="filter-group">
                    <button class="filter-btn" data-filter="contains-skin">Has Skins</button>
                    <button class="filter-btn" data-filter="contains-coins">Has Coins</button>
                    <button class="filter-btn" data-filter="contains-dna">Has DNA</button>
                </div>
                <button id="reset-filters" class="reset-btn">Reset Filters</button>
            </div>
        </div>

        <div id="skin-list"></div>
        <div id="loading-message">Fetching and processing bundles...</div>
        <div id="no-results-message" class="hidden">No bundles match your search.</div>
    </div>
    
    <!-- Cart and Modal HTML remains unchanged -->
    <button id="cart-button">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
        <span id="cart-count">0</span>
    </button>
    <div id="cart-sidebar">
        <div id="cart-header"><h2>Your Cart</h2></div>
        <div id="cart-items"></div>
        <div id="cart-footer">
            <div id="cart-total"><span>Total:</span><span id="total-price">$0.00</span></div>
            <button id="checkout-btn">Checkout</button>
            <button id="clear-cart-btn">Clear Cart</button>
        </div>
    </div>
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h2>Encrypted Cart Token</h2>
            <p>Copy the token below.</p>
            <textarea id="encrypted-json" readonly></textarea>
            <div class="modal-actions">
                <button id="copy-btn" class="modal-btn">Copy to Clipboard</button>
                <button id="close-modal-btn" class="modal-btn">Close</button>
            </div>
        </div>
    </div>
    <div id="owner-modal-overlay" class="modal-overlay">
        <div id="owner-modal-content" class="modal-content">
            <h2>Owner's Menu</h2>
            <p>Paste the order token below to decrypt and view the order details.</p>
            <textarea id="owner-token-input" placeholder="Paste encrypted token here..."></textarea>
            <div id="decrypted-order-results"></div>
            <div class="modal-actions">
                <button id="decrypt-btn" class="modal-btn" style="background-color: var(--price-color); color: white;">Decrypt Order</button>
                <button id="close-owner-modal-btn" class="modal-btn">Close</button>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const skinListContainer = document.getElementById('skin-list');
        const searchBox = document.getElementById('search-box');
        const debugLog = document.getElementById('debug-log');
        const loadingMessage = document.getElementById('loading-message');
        const noResultsMessage = document.getElementById('no-results-message');
        const minPriceSelect = document.getElementById('min-price');
        const maxPriceSelect = document.getElementById('max-price');
        const contentFilterBtns = document.querySelectorAll('.filter-btn');
        const resetFiltersBtn = document.getElementById('reset-filters');
        const cartButton = document.getElementById('cart-button');
        const cartSidebar = document.getElementById('cart-sidebar');
        const cartItemsContainer = document.getElementById('cart-items');
        const cartCount = document.getElementById('cart-count');
        const totalPriceEl = document.getElementById('total-price');
        const checkoutBtn = document.getElementById('checkout-btn');
        const clearCartBtn = document.getElementById('clear-cart-btn');
        const modalOverlay = document.getElementById('modal-overlay');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const copyBtn = document.getElementById('copy-btn');
        const encryptedJsonTextarea = document.getElementById('encrypted-json');
        const ownerModalOverlay = document.getElementById('owner-modal-overlay');
        const closeOwnerModalBtn = document.getElementById('close-owner-modal-btn');
        const decryptBtn = document.getElementById('decrypt-btn');
        const ownerTokenInput = document.getElementById('owner-token-input');
        const decryptedOrderResults = document.getElementById('decrypted-order-results');

        // --- App State ---
        let allCards = [];
        let cart = [];
        let skinMap = new Map();
        let imageBaseUrl = '';
        const priceTierMap = { "2":"$1.99","3":"$2.99","4":"$3.99","5":"$4.99","6":"$5.99","7":"$6.99","8":"$7.99","10":"$9.99","13":"$12.99","15":"$14.99","20":"$19.99","25":"$24.99","30":"$29.99","39":"$38.99","40":"$40.00","50":"$49.99","52":"$51.99","54":"$53.99","60":"$99.99" };
        const SECRET_KEY = "a-very-secret-32-byte-key-for-aes"; 
        const CART_STORAGE_KEY = 'vo3pal_agario_cart';

        let currentFilters = {
            searchTerm: '',
            minPrice: 0,
            maxPrice: Infinity,
            content: { 'contains-skin': false, 'contains-coins': false, 'contains-dna': false }
        };

        async function getLatestVersionId() {
            try {
                const response = await fetch('https://webbouncer-live-v8-0.agario.miniclippt.com/getLatestID');
                if (!response.ok) throw new Error('Network response failed');
                return (await response.text()).trim();
            } catch (error) {
                console.error("Failed to fetch latest version ID:", error);
                return null;
            }
        }

        async function main() {
            const versionId = await getLatestVersionId();
            if (!versionId) {
                debugLog.textContent = 'ERROR';
                loadingMessage.textContent = 'Could not fetch game version. Please refresh.';
                return;
            }
            debugLog.textContent = versionId;
            const configUrl = `https://configs-web.agario.miniclippt.com/live/v15/${versionId}/GameConfiguration.json`;
            imageBaseUrl = `https://configs-web.agario.miniclippt.com/live/v15/${versionId}/`;

            const bundles = await fetchData(configUrl);
            if (bundles) {
                populatePriceFilters();
                renderAllBundles(bundles.skinBundles, bundles.nonSkinBundles);
                setupEventListeners();
                loadCartFromStorage(); // Load after rendering so buttons can be updated
            }
        }

        async function fetchData(configUrl) {
            try {
                loadingMessage.style.display = 'block';
                const response = await fetch(configUrl);
                if (!response.ok) throw new Error(`Network error`);
                const data = await response.json();
                const { "Wallet - In-App Purchases": inAppPurchases, "Gameplay - Equippable Skins": allSkins } = data.gameConfig;
                skinMap = new Map(allSkins.map(skin => [skin.productId, skin]));
                let skinBundles = [], nonSkinBundles = [];
                inAppPurchases.forEach(purchase => {
                    const items = parseBundleId(purchase.bundleId);
                    if (items.length > 0) {
                        const price = parseFloat((priceTierMap[purchase.priceTier] || "0").replace('$', ''));
                        const bundleData = { items, price, bundleId: purchase.bundleId };
                        (items.some(i => i.type === 'skin') ? skinBundles : nonSkinBundles).push(bundleData);
                    }
                });
                return { skinBundles, nonSkinBundles };
            } catch (error) {
                console.error("Failed to fetch bundle data:", error);
                loadingMessage.textContent = 'Error loading bundle data.';
                return null;
            } finally {
                loadingMessage.style.display = 'none';
            }
        }

        function parseBundleId(bundleId) {
            const items = [];
            const parts = bundleId.split('_1_skin_');
            const nonSkinPart = parts[0];
            parts.slice(1).forEach(skinName => {
                const skin = skinMap.get(`skin_${skinName.trim()}`);
                if(skin) items.push({ type: 'skin', data: skin });
            });
            const coinMatch = nonSkinPart.match(/(\d+)_coins/);
            if (coinMatch) items.push({ type: 'coins', data: { name: `${parseInt(coinMatch[1]).toLocaleString()} coins` } });
            const dnaMatch = nonSkinPart.match(/(\d+)_dna/);
            if (dnaMatch) items.push({ type: 'dna', data: { name: `${parseInt(dnaMatch[1]).toLocaleString()} dna` } });
            return items;
        }

        function renderAllBundles(skinBundles, nonSkinBundles) {
            skinListContainer.innerHTML = '';
            allCards = [];
            skinBundles.forEach(bundle => allCards.push(createBundleCard(bundle)));
            if (nonSkinBundles.length > 0) {
                const separator = document.createElement('div');
                separator.className = 'section-header';
                separator.textContent = 'Currency & Item Packs';
                allCards.push(separator);
                nonSkinBundles.forEach(bundle => allCards.push(createBundleCard(bundle)));
            }
            skinListContainer.append(...allCards);
        }
        
        function createBundleCard(bundleData) {
            const { items, price, bundleId } = bundleData;
            const card = document.createElement('div');
            card.className = 'skin-card';
            card.dataset.bundleId = bundleId.toLowerCase();
            card.dataset.search = items.map(item => item.type === 'skin' ? item.data.productId : item.data.name).join(' ').toLowerCase();
            card.dataset.price = price.toFixed(2);
            card.dataset.containsSkin = items.some(i => i.type === 'skin');
            card.dataset.containsCoins = items.some(i => i.type === 'coins');
            card.dataset.containsDna = items.some(i => i.type === 'dna');
            
            const imageContainer = document.createElement('div');
            imageContainer.className = 'image-container';
            const detailsContainer = document.createElement('div');
            detailsContainer.className = 'details-container';
            const itemList = document.createElement('ul');
            itemList.className = 'item-list';
            items.sort((a, b) => a.type === 'skin' ? 1 : -1).forEach(item => {
                if (item.type === 'skin') {
                    const img = document.createElement('img');
                    img.src = imageBaseUrl + item.data.image;
                    imageContainer.appendChild(img);
                }
                itemList.innerHTML += `<li><span>${item.type === 'skin' ? item.data.productId : item.data.name}</span></li>`;
            });
            detailsContainer.appendChild(itemList);
            detailsContainer.innerHTML += `<p class="price">$${price.toFixed(2)}</p>`;
            const btn = document.createElement('button');
            btn.className = 'add-to-cart-btn';
            btn.textContent = 'Add to Cart';
            btn.dataset.bundleId = bundleId;
            detailsContainer.appendChild(btn);
            card.append(imageContainer, detailsContainer);
            return card;
        }

        function loadCartFromStorage() {
            const savedCart = localStorage.getItem(CART_STORAGE_KEY);
            if (savedCart) {
                try {
                    cart = JSON.parse(savedCart);
                } catch (e) {
                    console.error("Failed to parse saved cart:", e);
                    localStorage.removeItem(CART_STORAGE_KEY);
                }
            }
            updateCart();
        }

        function addToCart(bundleId) {
            const card = allCards.find(c => c.dataset && c.dataset.bundleId === bundleId);
            if (!card || cart.some(item => item.bundleId === bundleId)) return;
            const price = parseFloat(card.querySelector('.price').textContent.replace('$', ''));
            cart.push({ bundleId, price });
            updateCart();
        }

        function removeFromCart(bundleId) {
            cart = cart.filter(item => item.bundleId !== bundleId);
            updateCart();
        }

        function updateCart() {
            cartItemsContainer.innerHTML = '';
            let total = cart.reduce((sum, item) => sum + item.price, 0);
            if (cart.length === 0) {
                cartItemsContainer.innerHTML = `<p style="text-align: center; color: var(--text-secondary); padding: 20px 0;">Your cart is empty.</p>`;
            } else {
                cart.forEach(item => {
                    cartItemsContainer.innerHTML += `<div class="cart-item"><div class="cart-item-details"><p class="name">${item.bundleId}</p><p class="price">$${item.price.toFixed(2)}</p></div><button class="remove-item-btn" data-bundle-id="${item.bundleId}">&times;</button></div>`;
                });
            }
            totalPriceEl.textContent = `$${total.toFixed(2)}`;
            cartCount.textContent = cart.length;
            cartCount.classList.toggle('visible', cart.length > 0);
            document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
                const isInCart = cart.some(item => item.bundleId === btn.dataset.bundleId);
                btn.textContent = isInCart ? 'In Cart' : 'Add to Cart';
                btn.classList.toggle('in-cart', isInCart);
                btn.disabled = isInCart;
            });
            localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cart));
        }
        
        function populatePriceFilters() {
            const prices = Object.values(priceTierMap).map(p => parseFloat(p.replace('$', ''))).filter(p => p > 0).sort((a, b) => a - b);
            const uniquePrices = [...new Set(prices)];
            uniquePrices.forEach(price => {
                minPriceSelect.innerHTML += `<option value="${price}">$${price.toFixed(2)}</option>`;
                maxPriceSelect.innerHTML += `<option value="${price}">$${price.toFixed(2)}</option>`;
            });
        }
        
        function applyFilters() {
            let visibleCards = 0;
            allCards.forEach(card => {
                if (card.classList.contains('section-header')) return;
                const searchMatch = (card.dataset.search.includes(currentFilters.searchTerm) || card.dataset.bundleId.includes(currentFilters.searchTerm));
                const price = parseFloat(card.dataset.price);
                const priceMatch = (price >= currentFilters.minPrice && price <= currentFilters.maxPrice);
                
                // --- PATCHED LOGIC ---
                const contentMatch = Object.keys(currentFilters.content).every(key => {
                    const camelCaseKey = key.replace(/-(\w)/g, (_, c) => c.toUpperCase());
                    return !currentFilters.content[key] || card.dataset[camelCaseKey] === 'true';
                });
                
                if (searchMatch && priceMatch && contentMatch) {
                    card.classList.remove('hidden');
                    visibleCards++;
                } else {
                    card.classList.add('hidden');
                }
            });
            noResultsMessage.classList.toggle('hidden', visibleCards === 0);
        }

        async function getKey(secret) {
            const keyData = new TextEncoder().encode(secret.padEnd(32).substring(0,32));
            return await crypto.subtle.importKey('raw', keyData, { name: 'AES-GCM' }, false, ['encrypt', 'decrypt']);
        }

        async function encryptData(data) {
            const key = await getKey(SECRET_KEY);
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const encodedData = new TextEncoder().encode(JSON.stringify(data));
            const encryptedBuffer = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, encodedData);
            const combined = new Uint8Array(iv.length + encryptedBuffer.byteLength);
            combined.set(iv, 0);
            combined.set(new Uint8Array(encryptedBuffer), iv.length);
            return btoa(String.fromCharCode.apply(null, combined));
        }
        
        async function decryptData(token) {
            try {
                const key = await getKey(SECRET_KEY);
                const combined = new Uint8Array(atob(token).split('').map(c => c.charCodeAt(0)));
                const iv = combined.slice(0, 12);
                const encryptedData = combined.slice(12);
                const decryptedBuffer = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, encryptedData);
                return JSON.parse(new TextDecoder().decode(decryptedBuffer));
            } catch (e) { console.error("Decryption failed:", e); return null; }
        }
        
        function renderDecryptedOrder(data) {
            decryptedOrderResults.innerHTML = `<div class="decrypted-summary"><p>Order Total: ${data.total}</p><p>Timestamp: ${new Date(data.timestamp).toLocaleString()}</p></div>`;
            data.cart.forEach(item => {
                let imagesHTML = '<div class="decrypted-item-images">';
                parseBundleId(item.bundleId).filter(i => i.type === 'skin').forEach(skinItem => {
                    imagesHTML += `<img src="${imageBaseUrl}${skinItem.data.image}" alt="${skinItem.data.productId}">`;
                });
                imagesHTML += '</div>';
                decryptedOrderResults.innerHTML += `<div class="decrypted-item"><p class="name">${item.bundleId}</p><p class="price">$${item.price.toFixed(2)}</p>${imagesHTML}</div>`;
            });
        }

        function setupEventListeners() {
            searchBox.addEventListener('input', e => { currentFilters.searchTerm = e.target.value.toLowerCase(); applyFilters(); });
            minPriceSelect.addEventListener('change', e => { currentFilters.minPrice = parseFloat(e.target.value); applyFilters(); });
            maxPriceSelect.addEventListener('change', e => { currentFilters.maxPrice = parseFloat(e.target.value); applyFilters(); });
            contentFilterBtns.forEach(btn => btn.addEventListener('click', () => { btn.classList.toggle('active'); currentFilters.content[btn.dataset.filter] = !currentFilters.content[btn.dataset.filter]; applyFilters(); }));
            resetFiltersBtn.addEventListener('click', () => {
                searchBox.value = ''; minPriceSelect.value = '0'; maxPriceSelect.value = 'Infinity';
                contentFilterBtns.forEach(btn => btn.classList.remove('active'));
                currentFilters = { searchTerm: '', minPrice: 0, maxPrice: Infinity, content: { 'contains-skin': false, 'contains-coins': false, 'contains-dna': false } };
                applyFilters();
            });
            skinListContainer.addEventListener('click', e => { if (e.target.classList.contains('add-to-cart-btn')) addToCart(e.target.dataset.bundleId); });
            cartButton.addEventListener('click', () => cartSidebar.classList.toggle('open'));
            cartItemsContainer.addEventListener('click', e => { if (e.target.classList.contains('remove-item-btn')) removeFromCart(e.target.dataset.bundleId); });
            clearCartBtn.addEventListener('click', () => { if (cart.length > 0 && confirm('Are you sure?')) { cart = []; updateCart(); } });
            checkoutBtn.addEventListener('click', async () => {
                if (cart.length === 0) return alert("Your cart is empty!");
                encryptedJsonTextarea.value = await encryptData({ cart, total: totalPriceEl.textContent, timestamp: new Date().toISOString() });
                modalOverlay.classList.add('visible');
            });
            closeModalBtn.addEventListener('click', () => modalOverlay.classList.remove('visible'));
            copyBtn.addEventListener('click', async () => {
                await navigator.clipboard.writeText(encryptedJsonTextarea.value);
                copyBtn.textContent = 'Copied!';
                setTimeout(() => { copyBtn.textContent = 'Copy to Clipboard'; }, 2000);
            });
            document.addEventListener('keydown', e => { if (e.ctrlKey && e.altKey && e.key.toLowerCase() === 'o') { e.preventDefault(); ownerModalOverlay.classList.add('visible'); } });
            closeOwnerModalBtn.addEventListener('click', () => ownerModalOverlay.classList.remove('visible'));
            decryptBtn.addEventListener('click', async () => {
                const token = ownerTokenInput.value.trim();
                if (!token) return decryptedOrderResults.innerHTML = `<p style="color: var(--danger-color);">Please paste a token.</p>`;
                const decryptedData = await decryptData(token);
                if (decryptedData && decryptedData.cart) {
                    renderDecryptedOrder(decryptedData);
                } else {
                    decryptedOrderResults.innerHTML = `<p style="color: var(--danger-color);"><b>Decryption Failed.</b> The token is invalid.</p>`;
                }
            });
        }

        // --- Initial Execution ---
        main(); // This now handles loading the cart after rendering
    </script>
</body>
</html>
